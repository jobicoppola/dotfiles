#!/usr/bin/env bash

#=-----------------------------------------------------------------------------
#
# sadly didn't find this repo until after googling for many of the
# below items individually, but here is a handy reference:
# https://github.com/mathiasbynens/dotfiles/blob/master/.osx
#
#=-----------------------------------------------------------------------------

# enable trackpad tap to click for current user and login screen
defaults -currentHost write -globalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# disable focus ring animation
defaults write NSGlobalDomain NSUseAnimatedFocusRing -bool false

# disable natural trackpad scroll direction
defaults write NSGlobalDomain com.apple.swipescrolldirection -bool false

# disable press and hold, use fast key repeat instead
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# disable smart quotes
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false

# disable smart dashes
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false

# set fast key repeat
defaults write NSGlobalDomain KeyRepeat -int 2
defaults write NSGlobalDomain InitialKeyRepeat -int 12

# disable auto-correct
defaults write NSGlobalDomain NSAutomaticSpellingCorrectionEnabled -bool false

# check for updates daily instead of weekly
defaults write com.apple.SoftwareUpdate ScheduleFrequency -int 1

#=-----------------------------------------------------------------------------

# only show active apps in dock
defaults write com.apple.dock static-only -bool TRUE

# auto-hide the dock
defaults write com.apple.dock autohide -bool true

# autoshow and autohide the dock faster
defaults write com.apple.dock autohide-delay -int 0
defaults write com.apple.dock autohide-time-modifier -float 0.4

# set size of dock icons to 32 pixels
defaults write com.apple.dock tilesize -int 32

# turn on dock magnification and set size
defaults write com.apple.dock magnification -bool true
defaults write com.apple.dock largesize -int 96

# minimize windows with scale effect
defaults write com.apple.dock mineffect -string "scale"

# don't animate when opening apps from dock
defaults write com.apple.dock launchanim -bool false

# restart dock to enable changes above
killall Dock

#=-----------------------------------------------------------------------------

# set list view as default for finder
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# finder disable window and `get info` animations
defaults write com.apple.finder DisableAllAnimations -bool true

# finder show filename extensions
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# finder show status bar
defaults write com.apple.finder ShowStatusBar -bool true

# finder show path bar
defaults write com.apple.finder ShowPathbar -bool true

# finder display path in window title
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true

# Keep folders on top when sorting by name
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# don't create ds_store files on network volumes
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true

# When performing a search, search the current folder by default
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"

# open new finder window when volume is mounted
defaults write com.apple.frameworks.diskimages auto-open-ro-root -bool true
defaults write com.apple.frameworks.diskimages auto-open-rw-root -bool true
defaults write com.apple.finder OpenWindowForNewRemovableDisk -bool true

# hide icons on desktop
defaults write com.apple.finder CreateDesktop -bool false

# restart finder to enable changes
killall Finder

#=-----------------------------------------------------------------------------

# turn off dashboard
defaults write com.apple.dashboard mcx-disabled -bool true

# don't arrange spaces based on most recent use
defaults write com.apple.dock mru-spaces -bool false

# in mission control don't group windows by application
defaults write com.apple.dock expose-group-by-app -bool false

# speed up mission control animations
defaults write com.apple.dock expose-animation-duration -float 0.1

# hot corners set top left to misson control
defaults write com.apple.dock wvous-tl-corner -int 2
defaults write com.apple.dock wvous-tl-modifier -int 0

#=-----------------------------------------------------------------------------

# use only utf-8 in terminal.app
defaults write com.apple.terminal StringEncodings -array 4

# disable confirmation prompt when closing iterm2
defaults write com.googlecode.iterm2 PromptOnQuit -bool false

#=-----------------------------------------------------------------------------

# disable sudden motion sensor - pointless for ssd
sms_disable(){
    local msg="May need sudo - bc we are using ssd, disabling motion sensor..."
    local ssd=$(system_profiler SPStorageDataType |grep 'Medium Type' |grep -c SSD)
    if [ ${ssd} -gt 0 ]; then
        if [ $(pmset -g |grep -c sms) -gt 0 ]; then
            echo ${msg}
            sudo pmset -a sms 0
            [ $? -eq 0 ] && echo "done"
        fi
    fi
}

# tell spotlight not to index newly mounted and un-indexed volumes
spotlight_exclude(){
    local msg="May need sudo - setting up Spotlight exclude..."
    local spotlight_tmpfile=/tmp/.jc-spotlight-exclude
    local spotlight_excluded=0
    if [ -f $spotlight_tmpfile ]; then
        if [ $(grep "\/Volumes" $spotlight_tmpfile) ]; then
            spotlight_excluded=1
        fi
    fi
    if [ ${spotlight_excluded} -eq 0 ]; then
        echo ${msg}
        sudo defaults write \
            /.Spotlight-V100/VolumeConfiguration Exclusions -array "/Volumes"
        [ $? -eq 0 ] && echo "[1 of 2] done"
        sudo defaults read \
            /.Spotlight-V100/VolumeConfiguration Exclusions -array > $spotlight_tmpfile
        [ $? -eq 0 ] && echo "[2 of 2] done"
    fi
}

# disable transparency for menu bar and elsewhere
reduce_transparency(){
    echo -e "\nReducing transparency..."
    defaults write com.apple.universalaccess reduceTransparency -bool true
    [ $? -eq 0 ] && echo "done"
}

# fix font rendering for certain apps on mojave (e.g. iterm, atom, chrome)
# https://cl.ly/ec32950cc36f
fix_fonts_mojave(){
    echo -e "\nFixing mojave font rendering..."
    defaults write -g CGFontRenderingFontSmoothingDisabled -bool NO
    [ $? -eq 0 ] && echo "done"
}

#=-----------------------------------------------------------------------------

# set var if we are on os version before mojave
pre_mojave=0
[ $(uname -r |awk -F. '{print $1}') -lt 18 ] && pre_mojave=1

# set var when we are on mojave
mojave=0
[ $(uname -r |awk -F. '{print $1}') -eq 18 ] && mojave=1

# do certain things if we are pre-mojave
if [ ${pre_mojave} -eq 1 ]; then
    reduce_transparency
    spotlight_exclude
fi

# do certain things if we are on mojave
if [ ${mojave} -eq 1 ]; then
    fix_fonts_mojave
fi

# for all macos versions
sms_disable
